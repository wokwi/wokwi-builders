FROM espressif/idf-rust:all_1.71.0.1

USER root
RUN apt-get update
RUN apt-get install -y procps

USER esp
ENV USER=esp

# Install extra crates
RUN curl -L "https://github.com/rustsec/rustsec/releases/download/cargo-audit/v0.17.6/cargo-audit-x86_64-unknown-linux-gnu-v0.17.6.tgz" -o "${HOME}/.cargo/bin/cargo-audit.tgz" && \
    tar xf "${HOME}/.cargo/bin/cargo-audit.tgz" -C ${HOME}/.cargo/bin --strip-components 1 && \
    chmod u+x "${HOME}/.cargo/bin/cargo-audit" && \
    GENERATE_VERSION=$(git ls-remote --refs --sort="version:refname" --tags "https://github.com/cargo-generate/cargo-generate" | cut -d/ -f3- | tail -n1)  && \
    curl -L "https://github.com/cargo-generate/cargo-generate/releases/latest/download/cargo-generate-${GENERATE_VERSION}-x86_64-unknown-linux-gnu.tar.gz" -o "${HOME}/.cargo/bin/cargo-generate.tar.gz" && \
    tar xf "${HOME}/.cargo/bin/cargo-generate.tar.gz" -C ${HOME}/.cargo/bin && \
    chmod u+x "${HOME}/.cargo/bin/cargo-generate"

# Generate project templates
RUN cargo generate --vcs none esp-rs/esp-template --name rust-project-esp32 -d mcu=esp32 -d advanced=false
RUN cargo generate --vcs none esp-rs/esp-template --name rust-project-esp32s2 -d mcu=esp32s2 -d advanced=false
RUN cargo generate --vcs none esp-rs/esp-template --name rust-project-esp32s3 -d mcu=esp32s3 -d advanced=false
RUN cargo generate --vcs none esp-rs/esp-template --name rust-project-esp32c3 -d mcu=esp32c3 -d advanced=false

# Add alloc to the build-std property
RUN find . -name "config.toml" -type f -exec sed -i 's/build-std = \["core"\]/build-std = \["alloc", "core"\]/g' {} +

# Copy utility scripts and setup
COPY compile.sh /home/esp/
RUN mkdir -p /home/esp/build-in /home/esp/build-out
RUN pip3 install esptool

# Prebuild the template project for all targets, to test the container.
# We remove the target directory to reduce the image size.
RUN WOKWI_MCU=esp32 ./compile.sh && rm -rf rust-project-esp32/target
RUN WOKWI_MCU=esp32-c3 ./compile.sh && rm -rf rust-project-esp32c3/target
RUN WOKWI_MCU=esp32-s2 ./compile.sh && rm -rf rust-project-esp32s2/target
RUN WOKWI_MCU=esp32-s3 ./compile.sh && rm -rf rust-project-esp32s3/target

ENV HOME="/home/esp"
ENV HEXI_SRC_DIR="/home/esp/build-in"
ENV HEXI_SRC_FILES="*(*.rs|Cargo.toml)"
ENV HEXI_BUILD_CMD="bash /home/esp/compile.sh"
ENV HEXI_OUT_HEX="/home/esp/build-out/project.bin"
ENV HEXI_OUT_ELF="/home/esp/build-out/project.elf"
