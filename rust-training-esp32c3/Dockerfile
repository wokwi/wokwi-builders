# Base image
FROM espressif/rust-std-training

USER esp
ENV USER=esp

RUN git clone https://github.com/ferrous-systems/espressif-trainings.git espressif-trainings \
    && rm -rf espressif-trainings/book

ENV IDF_TOOLS_PATH=/home/esp/.espressif
RUN echo "source /home/esp/.espressif/frameworks/esp-idf/export.sh > /dev/null 2>&1" >> ~/.bashrc
ENV PATH=${PATH}:/home/esp/.cargo/bin

COPY sdkconfig.defaults /home/esp/
COPY cfg.toml /home/esp/
COPY compile.sh /home/esp/

RUN mkdir -p /home/esp/build-in /home/esp/build-out

ENV HEXI_SRC_DIR="/home/esp/build-in"
ENV HEXI_SRC_FILES="*.rs"
ENV HEXI_BUILD_CMD="bash /home/esp/compile.sh"
ENV HEXI_OUT_HEX="/home/esp/build-out/project.bin"
ENV HEXI_OUT_ELF="/home/esp/build-out/project.elf"

EXPOSE 8080
COPY --from=wokwi/mini-hexi /wokwi-hexi /wokwi-hexi
CMD /wokwi-hexi
